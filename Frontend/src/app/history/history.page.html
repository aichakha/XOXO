<div class="container">
  <ion-header class="navbar">
    <div class="logo">
      <div id="logo">
        <ion-buttons slot="start">
          <a (click)="Home()">
            <ion-img src="assets/icon/Logo2.png" style="height: 50px; width: auto;"></ion-img>
          </a>
        </ion-buttons>
      </div>
    </div>

    <nav>
      <ul>
        <li><a (click)="isAuthenticated ? Homeuser() : Home()">Home</a></li>
        <li><a (click)="History()">History</a></li>
        <li><a (click)="Contact()">How It Works</a></li>
      </ul>
    </nav>

    <div class="auth-buttons">
      <ng-container *ngIf="isAuthenticated; else loggedOut">
        <div class="user-avatar" (click)="showLogout = !showLogout">
          {{ getFirstLetter(username) }}
        </div>
        <ion-button *ngIf="showLogout && isAuthenticated" (click)="logout()" class="logout-button">
          LOGOUT
        </ion-button>
      </ng-container>
      
      <ng-template #loggedOut>
        <button class="sign-in" (click)="login()">LOG IN</button>
        <button class="join-now" (click)="signup()">JOIN NOW</button>
      </ng-template>
    </div>
  </ion-header>

  <ion-content class="history-page">
  
    <div class="search-container">
      <ion-searchbar 
        [(ngModel)]="searchTerm"
        (ionInput)="filterClips()"
        placeholder="Search in your history..."
        animated
        debounce="300">
      </ion-searchbar>
    </div>
    <!-- Category management section -->
    <div *ngIf="isAuthenticated" class="categories-section">
      <ion-chip (click)="filterByCategory(null)" [outline]="selectedCategory !== null">
        All
      </ion-chip>
      
      <ion-chip *ngFor="let category of categories" 
                (click)="filterByCategory(category.id)"
                [outline]="selectedCategory !== category.id">
        {{ category.name }}
        <ion-icon name="create-outline" (click)="editingCategory = category; $event.stopPropagation()"></ion-icon>
        <ion-icon name="trash"  (click)="deleteCategory(category.id); $event.stopPropagation()"></ion-icon>
      </ion-chip>

      <ion-chip (click)="showCategoryModal = true" color="primary">
        <ion-icon name="add"></ion-icon>
        New Category
      </ion-chip>
    </div>

    <!-- Category edit modal -->
    <div *ngIf="editingCategory" class="category-edit-modal">
      <div class="popup-content">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Edit Category</ion-card-title>
      </ion-card-header>
      <ion-card-content>
      <ion-input [(ngModel)]="editingCategory.name"></ion-input>
      <ion-button (click)="updateCategory(editingCategory)">Save</ion-button>
      <ion-button (click)="editingCategory = null" fill="outline">Cancel</ion-button>
    </ion-card-content>
  </ion-card>
</div>
    </div>

    <!-- New category modal (popup) -->
<div *ngIf="showCategoryModal" class="popup-overlay">
  <div class="popup-content">
    <ion-card>
      <ion-card-header>
        <ion-card-title>New Category</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-input [(ngModel)]="newCategoryName" placeholder="Category name"></ion-input>
        <ion-button (click)="createCategory(); showCategoryModal = false">Create</ion-button>
        <ion-button (click)="showCategoryModal = false" fill="outline">Cancel</ion-button>
      </ion-card-content>
    </ion-card>
  </div>
</div>
    <!-- ✅ Si l'utilisateur est connecté -->
    <div *ngIf="isAuthenticated; else loggedOutContent" class="content-container">
      <!-- ✅ Liste des notes complètes -->
      <div class="clips-container">
        <ion-card *ngFor="let clip of filteredClips" (click)="selectClip(clip)">
          <ion-card-header>
            <ion-card-title>
              <ion-input 
                [(ngModel)]="clip.title"
                (ionChange)="updateTitle(clip.id, clip.title)"
                placeholder="Modifier le titre">
              </ion-input>
            </ion-card-title>
            <ion-card-subtitle>{{ clip.createdAt | date }}</ion-card-subtitle>
          </ion-card-header>
          <ion-textarea [(ngModel)]="clip.content"
          (blur)="updateContent(clip.id, clip.content)"
          (keyup.enter)="updateContent(clip.id, clip.content)"
          (input)="autoSave()" 
          autoGrow="true"
          placeholder="Enter your text"
          class="editable-textarea">
          </ion-textarea>
           <!-- Ajoutez le sélecteur de catégorie ICI -->
    <ion-item lines="none" class="category-selector">
      <ion-label>Catégorie</ion-label>
      <ion-select 
        [(ngModel)]="clip.categoryId"
        (ionChange)="clip.categoryId ? assignToCategory(clip.id, clip.categoryId) : removeFromCategory(clip.id)"
        interface="popover">
        <ion-select-option [value]="null">Aucune catégorie</ion-select-option>
        <ion-select-option *ngFor="let category of categories" [value]="category.id">
          {{ category.name }}
        </ion-select-option>
      </ion-select>
    </ion-item>
          <ion-footer>
            <small>{{ clip.createdAt | date:'medium' }}</small>
            <ion-button fill="clear" size="small" (click)="toggleFavorite(clip); $event.stopPropagation()">
              <ion-icon 
                [name]="clip.isFavorite ? 'heart' : 'heart-outline'"
                [color]="clip.isFavorite ? 'danger' : 'medium'"
                style="font-size: 24px;">
              </ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" color="danger" (click)="deleteText(clip.id, $event)">
              <ion-icon name="trash" style="font-size: 24px;"></ion-icon>
            </ion-button>
          </ion-footer>

        </ion-card>
      </div>

      <!-- ✅ Panneau latéral des détails 
      <div class="note-details" *ngIf="selectedClip">
        <h2>{{ selectedClip.name }}</h2>
        <h4>{{ selectedClip.username }}</h4>
        <p>{{ selectedClip.text }}</p>
        <small>{{ selectedClip.date }}</small>
        <ion-button (click)="closeDetails()">Close</ion-button>
      </div>-->

      
    </div>

    <!-- ✅ Si l'utilisateur n'est PAS connecté -->
    <ng-template #loggedOutContent>
      <div class="content-container">
        <!-- ✅ Clip démo -->
        <div class="clips-container">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Sample Clip</ion-card-title>
              <ion-card-subtitle>Guest User</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              History where you can store your transcribed, summarized and translated text...
              Don't hesitate to start using our app.
            </ion-card-content>
          </ion-card>
        </div>
      </div>
    </ng-template>
  </ion-content>

  <!-- ✅ Footer -->
  <footer class="footer">
    <p>© 2025 Recapify Inc. All rights reserved.</p>
  </footer>
</div>
