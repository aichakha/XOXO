<div class="container">
  <ion-header>
    <app-navbar></app-navbar>
  </ion-header>


  <ion-content class="history-page">

    <div class="search-container">
      <ion-searchbar
        [(ngModel)]="searchTerm"
        (ionInput)="filterClips()"
        placeholder="Search in your history..."
        animated
        debounce="300">
      </ion-searchbar>
    </div>
    <!-- Category management section -->
    <div *ngIf="isAuthenticated" class="categories-section">
      <ion-chip class="category-chip" (click)="toggleFavoriteFilter()">
        <ion-icon
    [name]="showOnlyFavorites ? 'heart' : 'heart-outline'"
    [color]="showOnlyFavorites ? 'danger' : 'medium'"
    class="ion-margin-end"
  ></ion-icon>
  <span>{{ showOnlyFavorites ? 'Only Favorites' : 'All Texts' }}</span>
      </ion-chip>


      <ion-chip class="category-chip" (click)="togglePinnedFilter()">
        <ion-icon
        [name]="showOnlyPinned ? 'pin' : 'pin-outline'"
        [color]="showOnlyPinned ? 'secondary' : 'medium'"
        class="ion-margin-end"
      ></ion-icon>
      <span>{{ showOnlyPinned ? 'Only Pinned' : 'All Texts' }}</span>
      </ion-chip>

      <ion-chip (click)="filterByCategory(null)" [outline]="selectedCategory !== null">
        All
      </ion-chip>

      <ion-chip *ngFor="let category of categories"
                (click)="filterByCategory(category.id)"
                [outline]="selectedCategory !== category.id">
        {{ category.name }}
        <ion-icon name="create-outline" (click)="editingCategory = category; $event.stopPropagation()"></ion-icon>
        <ion-icon name="trash"  (click)="deleteCategory(category.id); $event.stopPropagation()"></ion-icon>
      </ion-chip>

      <ion-chip (click)="showCategoryModal = true" color="primary">
        <ion-icon name="add"></ion-icon>
        New Category
      </ion-chip>
    </div>

    <!-- Category edit modal -->
    <div *ngIf="editingCategory" class="category-edit-modal">
      <div class="popup-content">
    <ion-card>
      <ion-card-header>
        <ion-card-title>Edit Category</ion-card-title>
      </ion-card-header>
      <ion-card-content>
      <ion-input [(ngModel)]="editingCategory.name"></ion-input>
      <ion-button (click)="updateCategory(editingCategory)">Save</ion-button>
      <ion-button (click)="editingCategory = null" fill="outline">Cancel</ion-button>
    </ion-card-content>
  </ion-card>
</div>
    </div>

    <!-- New category modal (popup) -->
<div *ngIf="showCategoryModal" class="popup-overlay">
  <div class="popup-content">
    <ion-card>
      <ion-card-header>
        <ion-card-title>New Category</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-input [(ngModel)]="newCategoryName" placeholder="Category name"></ion-input>
        <ion-button (click)="createCategory(); showCategoryModal = false">Create</ion-button>
        <ion-button (click)="showCategoryModal = false" fill="outline">Cancel</ion-button>
      </ion-card-content>
    </ion-card>
  </div>
</div>
    <!-- ✅ Si l'utilisateur est connecté -->
    <div *ngIf="isAuthenticated; else loggedOutContent" class="content-container">
      <!-- ✅ Liste des notes complètes -->
      <div class="clips-container">
        <!-- ✅ Aucun texte sauvegardé -->
        <ion-card *ngIf="noSavedText || filteredClips.length === 0">
          <ion-card-header>
            <ion-card-title>No Saved Texts</ion-card-title>
            <ion-card-subtitle>Start using the APP and save your texts</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            History where you can store your transcribed, summarized and translated text...
            Don't hesitate to start using our app.
          </ion-card-content>
        </ion-card>
        <!-- ✅ Liste des notes -->
        <ion-card *ngFor="let clip of filteredClips">
          <ion-card-header>
            <ion-card-title>
              <ion-input
                [(ngModel)]="clip.title"
                (ionChange)="updateTitle(clip.id, clip.title)"
                placeholder="Modify title">
              </ion-input>
            </ion-card-title>
            <ion-card-subtitle>{{ clip.createdAt | date }}</ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>

            <div class="text-container">
              <!-- Affichage texte -->
              <div *ngIf="!clip.isExpanded">
                {{ clip.content | slice:0:100 }}<span *ngIf="clip.content.length > 100">...</span>
                <div class="see-more" *ngIf="clip.content.length > 100" (click)="clip.isExpanded = true">
                  See More ...
                </div>
              </div>

              <!-- Mode édition -->
              <div *ngIf="clip.isExpanded">
                <ion-textarea
                  [(ngModel)]="clip.content"
                  autoGrow="true"
                  placeholder="Update Text"
                  (blur)="updateContentAutoSave(clip.id, clip.content)"
                  (keydown.enter)="updateContentAutoSave(clip.id, clip.content)">
                </ion-textarea>

                <div class="see-less" (click)="clip.isExpanded = false">
                  See Less ...
                </div>
              </div>
            </div>


          </ion-card-content>






           <!-- Ajoutez le sélecteur de catégorie ICI -->
    <ion-item lines="none" class="category-selector">
      <ion-label>Catégorie</ion-label>
      <ion-select
        [(ngModel)]="clip.categoryId"
        (ionChange)="onCategoryChange(clip)"
        interface="popover">
        <ion-select-option value="none">Aucune catégorie</ion-select-option>
<ion-select-option *ngFor="let category of categories" [value]="category.id">
  {{ category.name }}
</ion-select-option>
        <ion-select-option value="new">Nouvelle catégorie</ion-select-option>
      </ion-select>
    </ion-item>
    <ion-footer class="ion-padding-horizontal" style="display: flex; align-items: center; justify-content: space-between;">
      <small>{{ clip.createdAt | date:'medium' }}</small>

      <div style="display: flex; align-items: center; gap: 8px;">
        <ion-button fill="clear" size="small" (click)="toggleFavorite(clip); $event.stopPropagation()">
          <ion-icon
            [name]="clip.isFavorite ? 'heart' : 'heart-outline'"
            [color]="clip.isFavorite ? 'danger' : 'medium'"
            style="font-size: 24px;">
          </ion-icon>
        </ion-button>

        <ion-button fill="clear" size="small" (click)="togglePin(clip); $event.stopPropagation()">
          <ion-icon
            [name]="clip.isPinned ? 'pin' : 'pin'"
            [color]="clip.isPinned ? 'purple' : 'medium'"
            style="font-size: 24px;">
          </ion-icon>
        </ion-button>

        <!-- Bouton principal "Share" -->
<!-- Bouton principal "Share" -->
       <ion-button fill="clear" (click)="toggleShareOptions(); $event.stopPropagation()" style="display: flex; align-items: center;">
  <ion-icon name="share-social-outline" style="margin-right: -20px;"></ion-icon>
  <ion-icon [name]="showShareOptions ? 'chevron-up-outline' : 'chevron-down-outline'" style="margin-left: 4px;"></ion-icon>
</ion-button>

<!-- Liste déroulante avec les options URL et Mail -->
<ion-list *ngIf="showShareOptions" class="share-sub-options" style="margin-left: 12px;">



  <ion-item (click)="openEmailModal(clip.content)">
    <ion-icon slot="start" name="mail-outline"></ion-icon>
    Mail
  </ion-item>

</ion-list>


        <ion-button fill="clear" size="small" (click)="selectAction('download', clip); $event.stopPropagation()">
          <ion-icon name="download-outline" style="font-size: 24px; color: blueviolet;"></ion-icon>
        </ion-button>


        <ion-button fill="clear" size="small" color="danger" (click)="deleteText(clip.id, $event)">
          <ion-icon name="trash" style="font-size: 24px;"></ion-icon>
        </ion-button>
      </div>
    </ion-footer>


        </ion-card>
      </div>
    </div>

    <!-- ✅ Si l'utilisateur n'est PAS connecté -->
    <ng-template #loggedOutContent>
      <div class="content-container">
        <!-- ✅ Clip démo -->
        <div class="clips-container">
          <ion-card *ngFor="let clip of filteredClips" (click)="toggleClip(clip)">
            <ion-card-header>
              <ion-card-title>{{ clip.title }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div
                [@expandCollapse]="selectedClip?.id === clip.id ? 'expanded' : 'collapsed'"
                class="animated-content"
              >
                {{ clip.content }}
              </div>
            </ion-card-content>

            <ion-button fill="clear" color="danger" size="small" (click)="deleteText(clip.id, $event)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </ion-card>
        </div>

      </div>
    </ng-template>
  </ion-content>

  <!-- ✅ Footer -->
  <footer class="footer">
    <p>© 2025 Recapify Inc. All rights reserved.</p>
  </footer>
</div>
